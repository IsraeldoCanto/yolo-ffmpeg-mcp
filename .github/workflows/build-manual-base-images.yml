name: Manual Base Image Build

on:
  workflow_dispatch:
    inputs:
      build_alpine:
        description: 'Build Alpine base image'
        required: true
        type: boolean
        default: true
      build_alpine_optimized:
        description: 'Build Alpine optimized base image'
        required: true
        type: boolean
        default: true
      force_rebuild:
        description: 'Force rebuild (ignore cache)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/yolo-ffmpeg-mcp

jobs:
  build-base-alpine:
    if: ${{ inputs.build_alpine }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=base-alpine-latest
            type=raw,value=base-alpine-{{sha}}
            type=raw,value=base-alpine-{{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push Alpine base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: ${{ inputs.force_rebuild && '' || 'type=gha,scope=base-alpine' }}
          cache-to: type=gha,mode=max,scope=base-alpine
          platforms: linux/amd64,linux/arm64

      - name: Test Alpine base image
        run: |
          echo "üß™ Testing Alpine base image..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:base-alpine-latest \
            sh -c "ffmpeg -version && python --version && python -c 'import cv2, numpy, psutil; print(\"All deps OK\")'"
          echo "‚úÖ Alpine base image test passed"

  build-base-alpine-optimized:
    if: ${{ inputs.build_alpine_optimized }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=base-alpine-optimized-latest
            type=raw,value=base-alpine-optimized-{{sha}}
            type=raw,value=base-alpine-optimized-{{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push Alpine optimized base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base.optimized
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: ${{ inputs.force_rebuild && '' || 'type=gha,scope=base-alpine-optimized' }}
          cache-to: type=gha,mode=max,scope=base-alpine-optimized
          platforms: linux/amd64,linux/arm64

      - name: Test Alpine optimized base image
        run: |
          echo "üß™ Testing Alpine optimized base image..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:base-alpine-optimized-latest \
            sh -c "ffmpeg -version && python --version && python -c 'import cv2, numpy, psutil; print(\"All deps OK\")'"
          echo "‚úÖ Alpine optimized base image test passed"

  summary:
    runs-on: ubuntu-latest
    needs: [build-base-alpine, build-base-alpine-optimized]
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "üèóÔ∏è Manual Base Image Build Complete"
          echo "=================================="
          echo "Alpine base: ${{ needs.build-base-alpine.result }}"
          echo "Alpine optimized: ${{ needs.build-base-alpine-optimized.result }}"
          echo ""
          echo "üì¶ Available images:"
          echo "- ghcr.io/${{ github.repository_owner }}/yolo-ffmpeg-mcp:base-alpine-latest"
          echo "- ghcr.io/${{ github.repository_owner }}/yolo-ffmpeg-mcp:base-alpine-optimized-latest"
          echo ""
          echo "üîÑ Other workflows can now use these cached base images"