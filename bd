#!/bin/bash
# Build Detective - Quick CI Analysis
# Usage: ./bd <repo> <pr_number>

if [ $# -ne 2 ]; then
    echo "Usage: ./bd <repo> <pr_number>"
    echo "Example: ./bd StigLau/yolo-ffmpeg-mcp 16"
    exit 1
fi

REPO=$1
PR=$2

echo "üîç Build Detective Analysis - $REPO PR#$PR"
echo "============================================================"

# Check current PR status
echo "üìä Current Status:"
gh pr view $PR --repo $REPO --json statusCheckRollup | jq '.statusCheckRollup[] | {name: .name, conclusion: .conclusion, workflow: .workflowName}' | jq -s 'group_by(.conclusion) | to_entries | .[] | {status: .key, count: (.value | length), checks: [.value[].name]}'

echo ""
echo "üö® Failed Checks:"
FAILURES=$(gh pr view $PR --repo $REPO --json statusCheckRollup | jq -r '.statusCheckRollup[] | select(.conclusion == "FAILURE") | .name')

if [ -z "$FAILURES" ]; then
    echo "‚úÖ No failures found! All checks are passing or running."
else
    echo "$FAILURES" | while read -r check; do
        echo "  ‚ùå $check"
    done
    
    echo ""
    echo "üîß Running Python Build Detective for detailed analysis..."
    uv run python scripts/bd_manual.py $REPO $PR
fi

echo ""
echo "üéØ BD Analysis Complete"