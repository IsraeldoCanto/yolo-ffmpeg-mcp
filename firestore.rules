rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==============================================
    // KOMPOSTEDIT COLLECTIONS
    // ==============================================
    
    // Kompositions - music/video compositions
    match /kompositions/{kompositionId} {
      // Owner can read, write, delete their own kompositions
      allow read, write, delete: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      
      // Allow creation if user owns the document
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId;
      
      // Allow read for public kompositions
      allow read: if resource.data.isPublic == true;
      
      // Allow read for shared kompositions
      allow read: if request.auth != null 
        && request.auth.uid in resource.data.sharedWith;
      
      // Validate komposition data structure
      allow write: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && isValidKomposition(request.resource.data);
    }
    
    // User profiles - self-access only
    match /users/{userId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;
      
      // Validate user profile structure
      allow write: if request.auth != null
        && request.auth.uid == userId
        && isValidUserProfile(request.resource.data);
    }
    
    // Sources - media file metadata
    match /sources/{sourceId} {
      // Owner can read, write, delete their own sources
      allow read, write, delete: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      
      // Allow creation if user owns the document
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId;
      
      // Allow read for shared sources
      allow read: if request.auth != null 
        && (resource.data.isShared == true 
        || request.auth.uid in resource.data.sharedWith);
      
      // Validate source data structure
      allow write: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && isValidSource(request.resource.data);
    }
    
    // ==============================================
    // EXISTING MULTIMEDIA COLLECTIONS
    // ==============================================
    
    // Allow users to read and write their own multimedia items
    match /multimedia_items/{document} {
      allow read, write, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Allow users to read and write their own tracks
    match /tracks/{document} {
      allow read, write, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
  }
}

// ==============================================
// VALIDATION FUNCTIONS
// ==============================================

// Validate komposition data structure
function isValidKomposition(data) {
  return data.keys().hasAll(['userId', 'name', 'revision', 'dvlType', 'bpm', 'segments', 'sources', 'config'])
    && data.userId is string
    && data.name is string
    && data.name.size() > 0
    && data.name.size() <= 100
    && data.revision is string
    && data.dvlType is string
    && data.dvlType in ['video', 'audio', 'image']
    && data.bpm is number
    && data.bpm >= 30
    && data.bpm <= 250
    && data.segments is list
    && data.sources is list
    && data.config is map
    && isValidVideoConfig(data.config);
}

// Validate video configuration
function isValidVideoConfig(config) {
  return config.keys().hasAll(['width', 'height', 'framerate', 'extensionType'])
    && config.width is number
    && config.width > 0
    && config.height is number
    && config.height > 0
    && config.framerate is number
    && config.framerate > 0
    && config.extensionType is string;
}

// Validate user profile data
function isValidUserProfile(data) {
  return data.keys().hasAll(['userId', 'email'])
    && data.userId is string
    && data.email is string
    && data.email.matches('.*@.*');
}

// Validate source data structure
function isValidSource(data) {
  return data.keys().hasAll(['userId', 'url', 'format', 'extensionType', 'mediaType'])
    && data.userId is string
    && data.url is string
    && data.url.size() > 0
    && data.format is string
    && data.extensionType is string
    && data.extensionType in ['video', 'audio', 'image']
    && data.mediaType is string;
}