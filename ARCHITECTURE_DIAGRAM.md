# Kompost Mixer - Architecture Diagram & Project Structure

## Overview
The Kompost Mixer application is a hybrid system combining multiple technologies and source projects. This document maps out the current architecture and explains how different components are integrated.

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KOMPOST MIXER ECOSYSTEM                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   FIREBASE       â”‚    â”‚    NEXT.JS       â”‚    â”‚    ELM EDITOR    â”‚
    â”‚   BACKEND        â”‚â—„â”€â”€â–ºâ”‚   FRONTEND       â”‚â—„â”€â”€â–ºâ”‚   (KOMPOSTEDIT)  â”‚
    â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
    â”‚  â€¢ Auth          â”‚    â”‚  â€¢ React UI      â”‚    â”‚  â€¢ Music Editor  â”‚
    â”‚  â€¢ Firestore     â”‚    â”‚  â€¢ TypeScript    â”‚    â”‚  â€¢ Composition   â”‚
    â”‚  â€¢ Storage       â”‚    â”‚  â€¢ Tailwind CSS  â”‚    â”‚  â€¢ Beat Sync     â”‚
    â”‚  â€¢ Rules         â”‚    â”‚  â€¢ Firebase SDK  â”‚    â”‚  â€¢ Elm Runtime   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                         â”‚                         â”‚
            â”‚                         â”‚                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   FFMPEG MCP     â”‚    â”‚   MULTIMEDIA     â”‚    â”‚   VIDEO/AUDIO    â”‚
    â”‚   SERVER         â”‚â—„â”€â”€â–ºâ”‚   PROCESSING     â”‚â—„â”€â”€â–ºâ”‚   ASSETS         â”‚
    â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
    â”‚  â€¢ Video Edit    â”‚    â”‚  â€¢ File Upload   â”‚    â”‚  â€¢ User Files    â”‚
    â”‚  â€¢ Audio Sync    â”‚    â”‚  â€¢ Metadata      â”‚    â”‚  â€¢ Generated     â”‚
    â”‚  â€¢ Effects       â”‚    â”‚  â€¢ Search/Filter â”‚    â”‚  â€¢ Temp Files    â”‚
    â”‚  â€¢ AI Analysis   â”‚    â”‚  â€¢ CRUD Ops      â”‚    â”‚  â€¢ Cache         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Source Projects & Git Repositories

### 1. **Main Application** - `kompost-mixer`
```
ğŸ“‚ https://github.com/StigLau/kompost-mixer.git
â”‚
â”œâ”€â”€ ğŸ—ï¸  Generated by: Firebase Studio (Gemini AI)
â”œâ”€â”€ ğŸ”§  Technology: Next.js 15 + TypeScript + Tailwind CSS
â”œâ”€â”€ ğŸ”  Authentication: Firebase Auth (Google OAuth)
â”œâ”€â”€ ğŸ’¾  Database: Firestore
â”œâ”€â”€ ğŸ“  Storage: Firebase Storage
â””â”€â”€ ğŸš€  Hosting: Firebase App Hosting
```

### 2. **ELM Editor** - `kompostedit` 
```
ğŸ“‚ /Users/stiglau/utvikling/privat/ElmMoro/kompostedit
â”‚
â”œâ”€â”€ ğŸ”—  Symlink: elm-kompostedit â†’ kompostedit
â”œâ”€â”€ ğŸ”§  Technology: Elm functional programming language
â”œâ”€â”€ ğŸµ  Purpose: Music composition and video editing
â”œâ”€â”€ ğŸ“¦  Output: kompost.js (371KB compiled)
â””â”€â”€ ğŸ”Œ  Integration: Ports for React â†” Elm communication
```

### 3. **Video Processing** - `yolo-ffmpeg-mcp`
```
ğŸ“‚ https://github.com/StigLau/yolo-ffmpeg-mcp.git  
â”‚
â”œâ”€â”€ ğŸ”§  Technology: Python + FastMCP + FFmpeg
â”œâ”€â”€ ğŸ¬  Purpose: Video/audio processing and effects
â”œâ”€â”€ ğŸ¤–  Features: AI content analysis, speech detection
â”œâ”€â”€ ğŸ“¹  Capabilities: Trimming, effects, format conversion
â””â”€â”€ ğŸ”Œ  Integration: MCP protocol for LLM interaction
```

### 4. **Legacy Project** - `kompost-web-ui` (âŒ Discontinued)
```
ğŸ“‚ /Users/stiglau/utvikling/privat/lm-ai/mcp/yolo-ffmpeg-mcp/kompost-web-ui/
â”‚
â”œâ”€â”€ âš ï¸   Status: Abandoned in favor of kompost-mixer
â”œâ”€â”€ ğŸ”§  Technology: React + TypeScript (not Next.js)
â”œâ”€â”€ ğŸ—ï¸  Purpose: Earlier attempt at React-Elm integration
â””â”€â”€ ğŸ“¦  Contains: ELM files, React components (copied to main project)
```

## Current File Structure

```
/Users/stiglau/utvikling/privat/lm-ai/mcp/yolo-ffmpeg-mcp/
â”‚
â”œâ”€â”€ ğŸ¯ kompost-mixer/                    # â† MAIN PROJECT (Firebase Studio)
â”‚   â”œâ”€â”€ src/app/                         # Next.js app router
â”‚   â”‚   â”œâ”€â”€ page.tsx                     # Login page
â”‚   â”‚   â”œâ”€â”€ multimedia/page.tsx          # File management 
â”‚   â”‚   â”œâ”€â”€ kompostedit/page.tsx         # ELM integration
â”‚   â”‚   â””â”€â”€ layout.tsx                   # Global layout
â”‚   â”œâ”€â”€ public/elm/                      # ELM compiled files
â”‚   â”‚   â”œâ”€â”€ kompost.js                   # Main ELM app (371KB)
â”‚   â”‚   â”œâ”€â”€ *.js.disabled                # Conflicting scripts (disabled)
â”‚   â”‚   â””â”€â”€ jsrsasign-latest-all-min.js  # Crypto library
â”‚   â”œâ”€â”€ firebase.json                    # Firebase rules config
â”‚   â”œâ”€â”€ firestore.rules                  # Database security
â”‚   â”œâ”€â”€ storage.rules                    # File access security
â”‚   â””â”€â”€ ELM_INTEGRATION_KNOWLEDGE.md     # Integration docs
â”‚
â”œâ”€â”€ ğŸš« kompost-web-ui/                   # â† LEGACY (discontinued)
â”‚   â”œâ”€â”€ src/components/                  # React components
â”‚   â”œâ”€â”€ public/elm/                      # ELM files (copied from)
â”‚   â””â”€â”€ [various React files]           # Superseded by kompost-mixer
â”‚
â”œâ”€â”€ firebase-kompost-mixer@              # â† SYMLINK to kompost-mixer
â”œâ”€â”€ elm-kompostedit@                     # â† SYMLINK to external ELM project
â”‚   â””â”€â”€ â†’ /Users/stiglau/utvikling/privat/ElmMoro/kompostedit
â”‚
â””â”€â”€ ğŸ”§ [FFMPEG MCP Server files]         # Video processing backend
    â”œâ”€â”€ src/server.py                    # MCP server
    â”œâ”€â”€ src/ffmpeg_wrapper.py            # Video operations
    â””â”€â”€ [Python modules]                 # AI analysis, effects, etc.
```

## Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER LOGIN    â”‚â”€â”€â”€â–ºâ”‚  FIREBASE AUTH  â”‚â”€â”€â”€â–ºâ”‚   NEXT.JS APP   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Google OAuth    â”‚    â”‚ ID Tokens       â”‚    â”‚ React Pages     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE UPLOADS   â”‚â”€â”€â”€â–ºâ”‚ FIREBASE STORAGEâ”‚â”€â”€â”€â–ºâ”‚ MULTIMEDIA MGR  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Audio/Video     â”‚    â”‚ User-scoped     â”‚    â”‚ CRUD Operations â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ELM KOMPOSTEDIT â”‚â—„â”€â”€â”€â”‚    PORT COMM    â”‚â—„â”€â”€â”€â”‚ REACT COMPONENT â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Music Editor    â”‚    â”‚ Bidirectional   â”‚    â”‚ /kompostedit    â”‚
â”‚ Composition     â”‚    â”‚ JSON Messages   â”‚    â”‚ Page            â”‚
â”‚ Beat Sync       â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                              â”‚
         â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KOMPOSITION   â”‚â”€â”€â”€â–ºâ”‚   FIRESTORE     â”‚â—„â”€â”€â”€â”‚   METADATA      â”‚
â”‚   DATA          â”‚    â”‚   DATABASE      â”‚    â”‚   STORAGE       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Beat patterns   â”‚    â”‚ User-scoped     â”‚    â”‚ Track info      â”‚
â”‚ Video segments  â”‚    â”‚ Collections     â”‚    â”‚ Search data     â”‚
â”‚ Audio tracks    â”‚    â”‚                 â”‚    â”‚ BPM, Genre, etc â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Integration Points & Challenges

### ğŸ”Œ **React â†” ELM Communication**
```typescript
// Challenge: Different runtime environments
// Solution: Port-based message passing

// React â†’ ELM
app.ports.loadKomposition.send(kompositionData);

// ELM â†’ React  
app.ports.kompositionUpdated.subscribe((data) => {
  saveToFirestore(data);
});
```

### ğŸ” **Firebase Authentication Flow**
```
1. User signs in with Google â†’ Firebase Auth
2. React gets ID token â†’ Pass to ELM via flags
3. ELM uses token â†’ API calls through React ports
4. Firestore rules â†’ Validate user access
```

### ğŸ“ **File Management Pipeline**
```
1. User uploads file â†’ Firebase Storage
2. Metadata extracted â†’ Firestore document
3. File URL generated â†’ Available in ELM
4. Processing request â†’ FFMPEG MCP server
5. Result stored â†’ Firebase Storage
```

## Current Issues & Technical Debt

### ğŸš© **Project Organization Issues**
1. **Multiple Source Projects**: Confusion between `kompost-mixer` vs `kompost-web-ui`
2. **Symlink Dependencies**: External ELM project dependency
3. **Git Repository Overlap**: Mixed repositories in same directory structure
4. **Legacy Files**: Disabled JS files in elm/ directory

### ğŸš© **Integration Complexities**
1. **Script Loading**: Custom dynamic loading required for ELM
2. **State Synchronization**: React state â†” ELM state coordination
3. **Build Dependencies**: ELM compilation separate from Next.js build
4. **Authentication Flow**: Multi-step token passing

### ğŸš© **Performance Concerns**
1. **Large ELM Bundle**: 371KB kompost.js file
2. **Multiple Runtimes**: React + ELM + Firebase SDKs
3. **File Upload Handling**: Large media files processing
4. **Real-time Sync**: Firestore listeners for collaboration

## Recommended Cleanup Actions

### ğŸ“‹ **Priority 1: Repository Organization**
```bash
# Consolidate into single clean structure
kompost-mixer/                    # Main project
â”œâ”€â”€ docs/                         # All documentation
â”œâ”€â”€ src/                          # Next.js application  
â”œâ”€â”€ elm-src/                      # ELM source (if included)
â”œâ”€â”€ public/                       # Static assets
â””â”€â”€ tools/                        # Build scripts, utilities
```

### ğŸ“‹ **Priority 2: Dependency Management**
1. **ELM Integration**: Include ELM source in main repository
2. **Build Pipeline**: Integrate ELM compilation with Next.js build
3. **Asset Optimization**: Code splitting for ELM bundle
4. **Script Loading**: Standardize with Next.js patterns

### ğŸ“‹ **Priority 3: Documentation**
1. **Setup Instructions**: Clear development environment setup
2. **Integration Guide**: React-ELM communication patterns  
3. **Firebase Config**: Security rules and deployment process
4. **Architecture Docs**: This document + component diagrams

## Future Architecture Vision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIFIED KOMPOST MIXER                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   WEB APP   â”‚  â”‚   ELM CORE  â”‚  â”‚  PROCESSING â”‚             â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚   ENGINE    â”‚             â”‚
â”‚  â”‚ Next.js UI  â”‚â—„â–ºâ”‚ Music Logic â”‚â—„â–ºâ”‚ FFMPEG/AI   â”‚             â”‚
â”‚  â”‚ Firebase    â”‚  â”‚ Composition â”‚  â”‚ Video Ops   â”‚             â”‚
â”‚  â”‚ Auth/Data   â”‚  â”‚ Beat Sync   â”‚  â”‚ Analysis    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                 â”‚
â”‚  Single Repository â€¢ Unified Build â€¢ Clear APIs                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This architecture provides a clear separation of concerns while maintaining the hybrid nature that makes Kompost Mixer unique in combining web technologies with functional programming for music composition.