rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==============================================
    // KOMPOSTEDIT MEDIA STORAGE
    // ==============================================
    
    // User media files - private by default
    match /media/{userId}/{allPaths=**} {
      // Users can read, write, delete their own media files
      allow read, write, delete: if request.auth != null 
        && request.auth.uid == userId;
      
      // Validate file size (max 100MB per file)
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size <= 100 * 1024 * 1024;
      
      // Validate file types for media uploads
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && isValidMediaType(request.resource.contentType);
    }
    
    // Shared media files - controlled access
    match /shared/{allPaths=**} {
      // Anyone authenticated can read shared files
      allow read: if request.auth != null;
      
      // Only authenticated users can upload to shared
      allow write: if request.auth != null
        && request.resource.size <= 100 * 1024 * 1024
        && isValidMediaType(request.resource.contentType);
      
      // Users can delete files they uploaded
      allow delete: if request.auth != null 
        && request.auth.uid == resource.metadata.uploadedBy;
    }
    
    // Temporary upload directory for processing
    match /temp/{userId}/{allPaths=**} {
      // Users can upload to their temp directory
      allow read, write, delete: if request.auth != null 
        && request.auth.uid == userId;
      
      // Validate file size and type
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size <= 500 * 1024 * 1024  // 500MB for temp files
        && isValidMediaType(request.resource.contentType);
    }
    
    // Public exports and rendered videos
    match /exports/{userId}/{allPaths=**} {
      // Users can read their own exports
      allow read: if request.auth != null 
        && request.auth.uid == userId;
      
      // System/backend can write export files
      allow write: if request.auth != null;
      
      // Users can delete their own exports
      allow delete: if request.auth != null 
        && request.auth.uid == userId;
    }
    
    // ==============================================
    // EXISTING MULTIMEDIA STORAGE
    // ==============================================
    
    // Allow users to read and write their own audio files
    match /audio/{userId}/{fileName} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read and write their own multimedia files
    match /multimedia/{userId}/{fileName} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // User uploads directory (existing pattern)
    match /uploads/{userId}/{allPaths=**} {
      allow read, write, delete: if request.auth != null 
        && request.auth.uid == userId;
    }
  }
}

// ==============================================
// VALIDATION FUNCTIONS
// ==============================================

// Validate media file types
function isValidMediaType(contentType) {
  return contentType.matches('video/.*')     // mp4, mov, avi, webm, etc.
    || contentType.matches('audio/.*')       // mp3, wav, m4a, etc.
    || contentType.matches('image/.*')       // jpg, png, gif, etc.
    || contentType == 'application/json';   // For komposition exports
}